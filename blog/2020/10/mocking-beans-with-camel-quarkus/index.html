<!doctype html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width,initial-scale=1"> <link rel="apple-touch-icon-precomposed" sizes="57x57" href="../../../../apple-touch-icon-57x57.png"> <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../../../../apple-touch-icon-114x114.png"> <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../../../../apple-touch-icon-72x72.png"> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../../../../apple-touch-icon-144x144.png"> <link rel="apple-touch-icon-precomposed" sizes="60x60" href="../../../../apple-touch-icon-60x60.png"> <link rel="apple-touch-icon-precomposed" sizes="120x120" href="../../../../apple-touch-icon-120x120.png"> <link rel="apple-touch-icon-precomposed" sizes="76x76" href="../../../../apple-touch-icon-76x76.png"> <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../../../apple-touch-icon-152x152.png"> <link rel="icon" type="image/png" href="../../../../favicon-196x196.png" sizes="196x196"> <link rel="icon" type="image/png" href="../../../../favicon-96x96.png" sizes="96x96"> <link rel="icon" type="image/png" href="../../../../favicon-32x32.png" sizes="32x32"> <link rel="icon" type="image/png" href="../../../../favicon-16x16.png" sizes="16x16"> <link rel="icon" type="image/png" href="../../../../favicon-128.png" sizes="128x128"> <meta name="application-name" content="Apache Camel"> <link rel="manifest" href="../../../../site.webmanifest"> <title>The Camel: mocking more than ever helped by Quarkus friend - Apache Camel</title> <link rel="canonical" href="../../../../blog/2020/10/mocking-beans-with-camel-quarkus/"> <link rel="stylesheet" href="../../../../_/css/site-6701f4f7c2.css"> </head> <body class="article"> <header class="header"> <nav class="navbar"> <div class="navbar-brand"> <a class="nav-logo" href="../../../../" title="Apache Camel"></a> <div id="topbar-nav" class="navbar-menu"> <div class="navbar-end"> <a class="navbar-item-section navbar-item navbar-topics" href="../../../../blog/"> <img alt="Blog" src="../../../../_/img/blog.svg"> Blog </a> <a class="navbar-item-section navbar-item navbar-topics" href="../../../../docs/"> <img alt="Documentation" src="../../../../_/img/documentation.svg"> Documentation </a> <a class="navbar-item-section navbar-item navbar-topics" href="../../../../community/"> <img alt="Community" src="../../../../_/img/community.svg"> Community </a> <a class="navbar-item-section navbar-item navbar-topics" href="../../../../download/"> <img alt="Download" src="../../../../_/img/download.svg"> Download </a> </div> </div> <div class="navbar-fill"></div> <div class="break-row"></div> <div class="navbar-search results-hidden"> <input id="search" class="search" placeholder="Search" autocomplete="off"> <img src="/_/img/cancel.svg" alt="Clear" id="search-cancel"> <div id="search_results"></div> </div> <div class="navbar-tools"> <a rel="noopener noreferrer nofollow" href="https://github.com/apache/camel/" title="Collaborate on GitHub"><svg focusable="false" class="brand-icon"><use href="../../../../_/img/brand-logos.svg#github"/></svg></a> <a rel="noopener noreferrer nofollow" href="https://camel.zulipchat.com" title="Chat on Zulip"><svg focusable="false" class="brand-icon"><use href="../../../../_/img/brand-logos.svg#zulip"/></svg></a> <a rel="noopener noreferrer nofollow" href="https://twitter.com/ApacheCamel" title="Follow Apache Camel on Twitter"><svg focusable="false" class="brand-icon"><use href="../../../../_/img/brand-logos.svg#twitter"/></svg></a> </div> <button class="navbar-burger" data-target="topbar-nav" type="button"> <span></span> <span></span> <span></span> </button> </div> </nav> </header> <div class="body"> <main role="main blog"> <article class="blog doc"> <header> <a class="category" href="../../../../categories/Howtos/">HOWTOS</a><a class="category" href="../../../../categories/Camel-Quarkus/">CAMEL QUARKUS</a> <h1>The Camel: mocking more than ever helped by Quarkus friend</h1> </header> <div class="post"> <aside> <div class="summary"></div> Posted on <time itemprop="published" datetime="2020-10-31" title="Saturday, October 31, 2020">October 31, 2020</time>, by <figure> <img src="https://avatars3.githubusercontent.com/u/22151349?v=4" alt="Alexandre Gallice"> <figcaption rel="author">Alexandre Gallice</figcaption> </figure> <p> <a class="arrow prev" href="../../../../blog/2020/10/VSCode-LanguageSupport-0.0.28/" title="Previous post: New release of VS Code Language Support for Apache Camel 0.0.28">&#10094;</a> </p> </aside> <div class="post-content"> <img class="featured" alt="Blog post featured image" src="../../../../blog/2020/10/mocking-beans-with-camel-quarkus/featured_hub81c87886f20198050360467481a1ccd_671212_800x0_resize_q95_gaussian.jpg" width="800" height="600"> <p>Even implementing a simple stateless micro-service, one could face situations where testing becomes hard. A lot of tools and techniques could help, but having something at hand quickly is very handy. In this post, I&rsquo;m introducing a Quarkus feature that plays nice with Camel in order to mock beans for test purpose.</p> <h2 id="camel-and-quarkus-together-for-mocking-beans">Camel and Quarkus together for mocking beans</h2> <p>It&rsquo;s long known that Camel offers great support for Java beans. Every time a developer needs custom code, this feature comes to the rescue.</p> <h3 id="a-route-using-a-bean">A route using a bean</h3> <p>Let&rsquo;s take a simple route below for demonstration purpose:</p> <pre><code class="language-java">from(&quot;platform-http:/semester&quot;).
choice().
  when(simple(&quot;${bean:monthBean} &lt;= 6&quot;)).
  setBody(constant(&quot;FIRST semester&quot;)).
otherwise().
  setBody(constant(&quot;SECOND semester&quot;)).
end();
</code></pre> <p>This simple Camel route informs the web client about the current semester. Step by step, it reacts to an incoming HTTP request, invokes a select method on a bean named <code>monthBean</code>, compares the returned value against the number <code>6</code> and finally set the reply accordingly. For instance, the HTTP response body will be <code>FIRST semester</code> when executed from January until June.</p> <h3 id="a-bean-used-from-a-route">A bean used from a route</h3> <p>Now let&rsquo;s define the bean invoked from the route with the code beneath:</p> <pre><code class="language-java">@ApplicationScoped
@Named(&quot;monthBean&quot;)
@RegisterForReflection
public class MonthBean {
  public int month() {
    return LocalDateTime.now().getMonth().getValue();
  }
}
</code></pre> <p>Helped with the <code>@Named</code> CDI annotation, we have just defined a bean named <code>monthBean</code> that could be referenced from a route. The <code>month()</code> method will return values ranging from <code>1</code> when executed in January up to <code>12</code> when executed in December.</p> <h3 id="a-first-canvas-for-testing">A first canvas for testing</h3> <p>As we are creating a simple HTTP based service, we could leverage on the <code>@QuarkusTest</code> annotation and the <code>RestAssured.given()</code> method for testing purpose. A possible implementation is proposed underneath:</p> <pre><code class="language-java">@QuarkusTest
public class SemesterRouteTest {
  @Test
  void runningThisTestInOctoberShouldIssueSecondSemester() {
    given().get(&quot;/semester&quot;).then().statusCode(200).body(is(&quot;SECOND semester&quot;));
  }
}
</code></pre> <p>It looks to be a good start. However, this test will obviously fail when executed from January until June. In other words, the test is not reproducible and it would be appreciable to fix this issue by mocking the <code>monthBean</code>.</p> <h3 id="injectmock-to-the-rescue">@InjectMock to the rescue</h3> <p>Luckily, Quarkus is providing the <code>@InjectMock</code> annotation in order to inject mocks in the CDI bean registry. This annotation is packaged in the <code>quarkus-junit5-mockito</code> artifact, so maven users would need to add a dependency like below:</p> <pre><code class="language-xml">&lt;dependency&gt;
  &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
  &lt;artifactId&gt;quarkus-junit5-mockito&lt;/artifactId&gt;
  &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;
</code></pre> <p>Camel is well integrated with the Quarkus registry, allowing us to write the following kind of tests:</p> <pre><code class="language-java">@QuarkusTest
public class SemesterRouteTest {
  @InjectMock
  MonthBean monthBean;

  @Test
  void januaryShouldIssueFirstSemester() {
    when(monthBean.month()).thenReturn(1);
    given().get(&quot;/semester&quot;).then().statusCode(200).body(is(&quot;FIRST semester&quot;));
  }
}
</code></pre> <p>At first, notice how we used <code>@InjectMock</code> to define the <code>MonthBean</code> mock. And later, the <a href="https://github.com/mockito/mockito" rel="nofollow noreferrer">Mockito</a> statement <code>when(monthBean.month()).thenReturn(1)</code> let us influence the behavior of the mock. As such, we are now able to simulate that the <code>month()</code> method is called in January at will.</p> <h3 id="more-good-news">More good news</h3> <p>Not solely have we fixed the reproducibility issue, but we are even able to complete the test coverage with more scenarios:</p> <pre><code class="language-java">@Test
void augustShouldIssueSecondSemester() {
  when(monthBean.month()).thenReturn(8);
  given().get(&quot;/semester&quot;).then().statusCode(200).body(is(&quot;SECOND semester&quot;));
}

@Test
void exceptionShouldIssueHttp500() {
  doThrow(new IllegalArgumentException(&quot;Simulating an exception&quot;)).when(monthBean).month();
  given().get(&quot;/semester&quot;).then().statusCode(500);
}
</code></pre> <h3 id="conclusion">Conclusion</h3> <p>So far, we have introduced a way to mock beans in Camel Quarkus tests. It helped us to define reproducible tests and to improve the test coverage. Note that <code>@InjectMock</code> works only in JVM Mode, yet it offers a good complement to native tests.</p> <p>The source code used in this blog post is hosted <a href="https://github.com/aldettinger/camel-quarkus-inject-mock" rel="nofollow noreferrer">on my github repository</a>.</p> <p>More information are available about the Quarkus mocking features in the great article from Georgios Andrianakis about <a href="https://quarkus.io/blog/mocking/" rel="nofollow noreferrer">Mocking CDI beans in Quarkus</a>. Finally, I would like to thank <a href="https://pixabay.com/users/blende12-201217/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=3901900" rel="nofollow noreferrer">Gerhard G.</a> for the mocking camel picture.</p> </div> </div> </article> </main> </div> <div class="footer-tools"> <a title="Improve this document, receive free virtual hugs &hearts;" href="https://github.com/apache/camel-website/edit/master/content/blog/2020/10/mocking-beans-with-camel-quarkus/index.md">Edit this Page</a> <a href="#top" title="Reach the top of the page">Back to top</a> </div> <footer> <div class="footer"> <figure class="logo"> <img class="logo" src="../../../../_/img/logo-d.svg" alt="Apache Camel Logo" aria-label="white silhouette of a camel in front of a sand dune"> </figure> <input id="footer-toggle-overview" type="checkbox" title="Show/Hide Overview section"> <dl> <dt><label for="footer-toggle-overview">Overview</label><label for="footer-toggle-overview">&#65291;</label></dt> <dd><a href="../../../../blog/">Blog</a></dd> <dd><a href="../../../../docs/">Documentation</a></dd> <dd><a href="../../../../community/support/">Community</a></dd> <dd><a href="../../../../blog/">Download</a></dd> </dl> <input id="footer-toggle-documentation" type="checkbox" title="Show/Hide Documentation section"> <dl> <dt><label for="footer-toggle-documentation">Documentation</label><label for="footer-toggle-documentation">&#65291;</label></dt> <dd><a href="../../../../manual/latest/">User Manual</a></dd> <dd><a href="../../../../components/latest/index.html">Components</a></dd> <dd><a href="../../../../camel-k/latest/">Camel-K</a></dd> <dd><a href="../../../../camel-kafka-connector/latest/">Camel Kafka Connector</a></dd> <dd><a href="../../../../camel-quarkus/latest/">Camel Quarkus</a></dd> <dd><a href="../../../../camel-spring-boot/latest/">Camel Spring Boot</a></dd> <dd><a href="../../../../camel-karaf/latest/">Camel Karaf</a></dd> <dd><a href="../../../../manual/latest/faq/index.html">FAQ</a></dd> </dl> <input id="footer-toggle-community" type="checkbox" title="Show/Hide Community section"> <dl> <dt><label for="footer-toggle-community">Community</label><label for="footer-toggle-community">&#65291;</label></dt> <dd><a href="../../../../community/support/">Support</a></dd> <dd><a href="../../../../manual/latest/contributing.html">Contributing</a></dd> <dd><a href="../../../../manual/latest/mailing-lists.html">Mailing Lists</a></dd> <dd><a href="../../../../community/user-stories/">User stories</a></dd> <dd><a href="../../../../community/articles/">Articles</a></dd> <dd><a href="../../../../community/books/">Books</a></dd> <dd><a href="../../../../community/team/">Team</a></dd> </dl> <input id="footer-toggle-about" type="checkbox" title="Show/Hide Acknowledgements section"> <dl> <dt><label for="footer-toggle-about">About</label><label for="footer-toggle-about">&#65291;</label></dt> <dd><a href="../../../../acknowledgments/">Acknowledgments</a> </dd><dd><a target="_blank" rel="noopener noreferrer nofollow" href="https://www.apache.org/events/current-event.html" title="Apache Events">Apache Events</a></dd> <dd><a target="_blank" rel="noopener noreferrer nofollow" href="https://www.apache.org/licenses/" title="License">License</a></dd> <dd><a target="_blank" rel="noopener noreferrer nofollow" href="https://www.apache.org/security/" title="Security">Security</a></dd> <dd><a target="_blank" rel="noopener noreferrer nofollow" href="https://www.apache.org/foundation/sponsorship.html" title="Sponsorship">Sponsorship</a></dd> <dd><a target="_blank" rel="noopener noreferrer nofollow" href="https://www.apache.org/foundation/thanks.html" title="Thanks">Thanks</a></dd> </dl> <p class="remark"> &copy; 2004-2020 The <a href="https://apache.org">Apache Software Foundation</a>.<br> Apache Camel, Camel, Apache, the Apache feather logo, and the Apache Camel project logo are trademarks of The Apache Software Foundation. All other marks mentioned may be trademarks or registered trademarks of their respective owners. </p> <div class="resources"> <div class="context"> <a href="../../../../privacy-policy/">Privacy Policy</a> </div> <div class="context"> <a target="_blank" rel="noopener noreferrer nofollow" href="https://www.apache.org/foundation/policies/conduct">Code of Conduct</a> </div> <div class="context"> <a href="../../../../sitemap/">Sitemap</a> </div> </div> <div class="footer-icons"> <a rel="noopener noreferrer nofollow" href="https://github.com/apache/camel/" title="Collaborate on GitHub"><svg class="brand-icon"><use href="../../../../_/img/brand-logos.svg#github"/></svg></a> <a rel="noopener noreferrer nofollow" href="https://camel.zulipchat.com" title="Chat on Zulip"><svg class="brand-icon"><use href="../../../../_/img/brand-logos.svg#zulip"/></svg></a> <a rel="noopener noreferrer nofollow" href="https://twitter.com/ApacheCamel" title="Follow Apache Camel on Twitter"><svg class="brand-icon"><use href="../../../../_/img/brand-logos.svg#twitter"/></svg></a> </div> </div> </footer> <script src="../../../../_/js/vendor/algoliasearch-7a1af112e6.js"></script> <script src="../../../../_/js/site-0d18f68ee9.js"></script> <script async src="../../../../_/js/vendor/highlight-a988c6fdd9.js"></script> <script async src="../../../../_/js/vendor/svg4everybody-195d47ce7d.js"></script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "Organization", "name": "Apache Camel", "url": "https:\/\/camel.apache.org\/" , "sameAs": ["https://twitter.com/ApacheCamel"] , "logo": "https:\/\/camel.apache.org\/_\/img\/logo-d.svg" , "description": "Apache Camel ™ is a versatile open-source integration framework based on known Enterprise Integration Patterns. Camel empowers you to define routing and mediation rules in a variety of domain-specific languages, including a Java-based Fluent API, Spring or Blueprint XML Configuration files, and a Scala DSL." } </script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "BreadcrumbList", "itemListElement": [{ "@type": "ListItem", "position": 1 , "item": { "@id": "https://camel.apache.org/", "name": "Apache Camel" } },{ "@type": "ListItem", "position": 2 , "item": { "@id": "https://camel.apache.org/blog/", "name": "blog" } },{ "@type": "ListItem", "position": 3 , "item": { "@id": "https://camel.apache.org/blog/2020/", "name": "2020" } },{ "@type": "ListItem", "position": 4 , "item": { "@id": "https://camel.apache.org/blog/2020/10/", "name": "10" } },{ "@type": "ListItem", "position": 5 , "item": { "@id": "https://camel.apache.org/blog/2020/10/mocking-beans-with-camel-quarkus/", "name": "mocking-beans-with-camel-quarkus" } }] } </script> </body> </html> 